<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emotion Trajectory Drawing</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js"></script>
</head>
<body>
    <div style="text-align: center;">
        <!-- Canvas for Drawing -->
        <canvas id="emotionCanvas" width="800" height="400" style="border:1px solid #000;"></canvas>
        <br>
        <!-- Clear and Submit Buttons -->
        <button id="clearCanvas" type="button">Clear</button>
        <button id="submitCanvas" type="button">Submit</button>
    </div>

    <script>
        // Firebase configuration (replace with your Firebase project details)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Set up canvas and context
        const canvas = document.getElementById("emotionCanvas");
        const ctx = canvas.getContext("2d");

        // Define scales for time (X-axis) and intensity (Y-axis)
        const timeScale = 60; // Time in minutes
        const intensityScale = 9; // Intensity range

        // Variables for drawing
        let isDrawing = false; // Tracks whether the user is currently drawing
        let dataPoints = []; // Array to store time-intensity points

        // Function to draw axes and labels on the canvas
        function drawAxes() {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw X-axis (Time)
            ctx.beginPath();
            ctx.moveTo(50, canvas.height - 50); // Start at bottom-left corner
            ctx.lineTo(canvas.width - 50, canvas.height - 50); // Horizontal line
            ctx.stroke();

            // Draw Y-axis (Intensity)
            ctx.beginPath();
            ctx.moveTo(50, canvas.height - 50); // Start at bottom-left corner
            ctx.lineTo(50, 50); // Vertical line
            ctx.stroke();

            // Add axis labels
            ctx.font = "16px Arial";
            ctx.fillText("Time (minutes)", canvas.width / 2, canvas.height - 20); // X-axis label
            ctx.save();
            ctx.translate(20, canvas.height / 2); // Move to Y-axis center
            ctx.rotate(-Math.PI / 2); // Rotate for vertical text
            ctx.fillText("Emotion Intensity", 0, 0); // Y-axis label
            ctx.restore();

            // Add X-axis ticks and labels (10-minute intervals)
            const xInterval = 10; // Interval for time
            const xStep = (canvas.width - 100) / (timeScale / xInterval);
            for (let i = 0; i <= timeScale; i += xInterval) {
                const x = 50 + (i / timeScale) * (canvas.width - 100);
                ctx.beginPath();
                ctx.moveTo(x, canvas.height - 50); // Bottom of axis
                ctx.lineTo(x, canvas.height - 45); // Small tick mark
                ctx.stroke();
                ctx.fillText(i, x - 10, canvas.height - 30); // Label
            }

            // Add Y-axis ticks and labels (0-9 scale)
            const yStep = (canvas.height - 100) / intensityScale;
            for (let i = 0; i <= intensityScale; i++) {
                const y = canvas.height - 50 - (i / intensityScale) * (canvas.height - 100);
                ctx.beginPath();
                ctx.moveTo(50, y); // Left of axis
                ctx.lineTo(45, y); // Small tick mark
                ctx.stroke();
                ctx.fillText(i, 30, y + 5); // Label
            }
        }

        // Initialize the canvas with axes
        drawAxes();

        // Event listeners for drawing
        canvas.addEventListener("mousedown", (e) => {
            isDrawing = true; // Start drawing
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });

        canvas.addEventListener("mousemove", (e) => {
            if (isDrawing) {
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();

                // Record normalized time and intensity
                let time = ((e.offsetX - 50) / (canvas.width - 100)) * timeScale; // Normalize X
                let intensity = ((canvas.height - 50 - e.offsetY) / (canvas.height - 100)) * intensityScale; // Normalize Y
                if (time >= 0 && time <= timeScale && intensity >= 0 && intensity <= intensityScale) {
                    dataPoints.push({ time: time.toFixed(2), intensity: intensity.toFixed(2) });
                }
            }
        });

        canvas.addEventListener("mouseup", () => {
            isDrawing = false; // Stop drawing
        });

        canvas.addEventListener("mouseleave", () => {
            isDrawing = false; // Stop drawing if mouse leaves canvas
        });

        // Clear the canvas and reset data points
        document.getElementById("clearCanvas").addEventListener("click", () => {
            drawAxes(); // Redraw axes
            dataPoints = []; // Reset points
        });

        // Submit the trajectory data to Firebase
        document.getElementById("submitCanvas").addEventListener("click", () => {
            const dataString = JSON.stringify(dataPoints);

            // Save to Firebase
            db.collection("emotion_trajectories").add({
                trajectory: dataPoints,
                timestamp: new Date()
            })
            .then(() => {
                alert("Your data has been saved!");
                dataPoints = []; // Clear the points after submission
                drawAxes(); // Reset canvas
            })
            .catch((error) => {
                console.error("Error saving data: ", error);
                alert("There was an error saving your data. Please try again.");
            });
        });
    </script>
</body>
</html>
